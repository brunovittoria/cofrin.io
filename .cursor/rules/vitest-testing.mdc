---
description: Comprehensive testing guidelines using Vitest for the Cofrinio project.
globs: **/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
alwaysApply: false
---

# Testing Guidelines

## Testing Framework

- `vitest` is used for testing
- Tests are colocated next to the tested file
  - Example: `dir/format.ts` and `dir/format.test.ts`
- Use `@testing-library/react` for component testing

## Test Structure (AAA Pattern)

All tests should follow the **Arrange-Act-Assert** pattern:

```typescript
describe('CategoryService', () => {
  it('should create a category successfully', async () => {
    // Arrange - Setup test data and mocks
    const mockCategory = { id: 1, nome: 'Test', tipo: 'despesa' };
    vi.spyOn(supabase, 'insert').mockResolvedValue({ data: mockCategory, error: null });

    // Act - Execute the code being tested
    const result = await createCategory({ nome: 'Test', tipo: 'despesa' });

    // Assert - Verify the results
    expect(result).toEqual(mockCategory);
    expect(supabase.insert).toHaveBeenCalledWith({ nome: 'Test', tipo: 'despesa' });
  });
});
```

## Mocking Rules

### Never Connect to Real Services

```typescript
// ❌ Bad: Real database connection
const result = await supabase.from('categories').select('*');

// ✅ Good: Mocked response
vi.mock('@/integrations/supabase/client');
const mockSupabase = vi.mocked(supabase);
mockSupabase.from.mockReturnValue({
  select: vi.fn().mockResolvedValue({ data: mockData, error: null }),
});
```

### Always Mock External Dependencies

```typescript
// Mock Supabase client
vi.mock('@/integrations/supabase/client', () => ({
  supabase: {
    from: vi.fn(() => ({
      select: vi.fn(),
      insert: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
    })),
  },
}));

// Mock API hooks
vi.mock('@/hooks/api/useCategories', () => ({
  useCategories: vi.fn(() => ({
    data: [],
    isLoading: false,
    error: null,
  })),
  useCreateCategory: vi.fn(() => ({
    mutate: vi.fn(),
    isPending: false,
  })),
}));
```

### Mock Utilities

```typescript
// vi.fn() - Create a mock function
const mockFn = vi.fn();
const mockFnWithReturn = vi.fn(() => 'return value');

// vi.spyOn() - Spy on existing method
const spy = vi.spyOn(object, 'method');
spy.mockReturnValue('mocked');
spy.mockResolvedValue('async mocked');
spy.mockRejectedValue(new Error('error'));

// vi.mocked() - Type-safe mock access
const mockedModule = vi.mocked(importedModule);
```

## Test Scenarios

### Always Test Both Success and Error Cases

```typescript
describe('useCreateCategory', () => {
  it('should create category on success', async () => {
    const mockData = { id: 1, nome: 'Test' };
    mockSupabase.insert.mockResolvedValue({ data: mockData, error: null });

    const result = await createCategory({ nome: 'Test' });

    expect(result).toEqual(mockData);
  });

  it('should throw error on failure', async () => {
    const mockError = { message: 'Database error' };
    mockSupabase.insert.mockResolvedValue({ data: null, error: mockError });

    await expect(createCategory({ nome: 'Test' })).rejects.toThrow('Database error');
  });
});
```

### Test Edge Cases

```typescript
describe('formatCurrency', () => {
  it('should format positive numbers', () => {
    expect(formatCurrency(1000)).toBe('R$ 1.000,00');
  });

  it('should format negative numbers', () => {
    expect(formatCurrency(-500)).toBe('-R$ 500,00');
  });

  it('should handle zero', () => {
    expect(formatCurrency(0)).toBe('R$ 0,00');
  });

  it('should handle null/undefined', () => {
    expect(formatCurrency(null)).toBe('R$ 0,00');
    expect(formatCurrency(undefined)).toBe('R$ 0,00');
  });

  it('should handle decimal values', () => {
    expect(formatCurrency(99.99)).toBe('R$ 99,99');
  });
});
```

## Component Testing

### Testing with React Testing Library

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
};

describe('CategoryModal', () => {
  it('should render form fields', () => {
    render(<CategoryModal />, { wrapper: createWrapper() });

    expect(screen.getByLabelText(/nome/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/tipo/i)).toBeInTheDocument();
  });

  it('should call onSubmit with form data', async () => {
    const user = userEvent.setup();
    const mockSubmit = vi.fn();

    render(<CategoryModal onSubmit={mockSubmit} />, { wrapper: createWrapper() });

    await user.type(screen.getByLabelText(/nome/i), 'Test Category');
    await user.click(screen.getByRole('button', { name: /criar/i }));

    await waitFor(() => {
      expect(mockSubmit).toHaveBeenCalledWith(
        expect.objectContaining({ nome: 'Test Category' })
      );
    });
  });
});
```

## Hook Testing

```typescript
import { renderHook, waitFor } from '@testing-library/react';

describe('useCategoryForm', () => {
  it('should initialize with default values', () => {
    const { result } = renderHook(() => useCategoryForm({ mode: 'create' }));

    expect(result.current.formData).toEqual({
      nome: '',
      descricao: '',
      tipo: '',
      cor_hex: '',
    });
  });

  it('should update field value', () => {
    const { result } = renderHook(() => useCategoryForm({ mode: 'create' }));

    act(() => {
      result.current.updateField('nome', 'New Name');
    });

    expect(result.current.formData.nome).toBe('New Name');
  });
});
```

## Cleanup and Isolation

### Always Clear Mocks

```typescript
describe('MyService', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  // Tests...
});
```

### Reset Module State When Needed

```typescript
beforeEach(() => {
  vi.resetModules();
});
```

## Coverage Requirements

- **Target minimum 80% coverage** for critical business logic
- Cover all public methods/functions
- Cover both success and error paths
- Test edge cases and boundary conditions

Run coverage with:

```bash
pnpm test --coverage
```

## Quality Standards

A good test must be:

| Quality | Description |
|---------|-------------|
| Independent | Does not depend on other tests |
| Deterministic | Always produces the same result |
| Fast | No real I/O operations |
| Readable | Clear describe/it blocks |
| Focused | Tests one thing at a time |

## Common Errors to Avoid

| Error | Problem | Solution |
|-------|---------|----------|
| Real database calls | Slow, flaky tests | Always mock external services |
| Not clearing mocks | Test pollution | Use `vi.clearAllMocks()` in `beforeEach` |
| Missing error tests | Incomplete coverage | Test both success and error cases |
| Dependent tests | Order-dependent failures | Each test should setup its own state |
| Testing implementation | Brittle tests | Test behavior, not internal details |
| Missing async/await | Unhandled promises | Always await async operations |
| Hardcoded timeouts | Flaky tests | Use `waitFor` instead of `setTimeout` |

## Test File Template

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';

// Mocks
vi.mock('@/integrations/supabase/client');

describe('ModuleName', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  describe('functionName', () => {
    it('should handle success case', async () => {
      // Arrange
      // Act
      // Assert
    });

    it('should handle error case', async () => {
      // Arrange
      // Act
      // Assert
    });

    it('should handle edge case', async () => {
      // Arrange
      // Act
      // Assert
    });
  });
});
```

## Documentation References

| Technology | Documentation |
|------------|---------------|
| Vitest | https://vitest.dev/guide/ |
| Testing Library | https://testing-library.com/docs/react-testing-library/intro/ |
| Testing Library User Event | https://testing-library.com/docs/user-event/intro |
| Vitest Mocking | https://vitest.dev/guide/mocking.html |
